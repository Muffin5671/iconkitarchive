<!DOCTYPE html>
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135255146-3"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-135255146-3');</script>
    <title>Online Icon Kit</title>
    <link href="../assets/css/iconkit.css?v=9e" type="text/css" rel="stylesheet">
    <meta name="viewport" content="width=1024">
    <meta property="og:description" content="Build and save your very own Geometry Dash icons, right from the internet!">
    <meta property="og:title" content="Geometry Dash Online Icon Kit">
    <meta property="og:type" content="website">
    <meta name="og:image" itemprop="image" content="https://gdbrowser.com/assets/icon.png">
    <meta name="theme-color" content="#CCFF55">
    <meta name="twitter:card" content="summary">
    <link rel="icon" href="../assets/icon.png"></link>
</head>
<body onbeforeunload="sessionStorage.setItem('prevUrl', window.location.href)">
<div class="center">

    <div class="popup" id="mobileInfo">
        <div class="fancybox bounce center supercenter" style="width: 600px; padding-bottom: 20px">
            <h1 id="extraInfoText" class="center gold" style="margin-top: 14px; margin-bottom: 20px; overflow: visible;">Info</h1>
            <div id="extraInfoPopup"></div>
            <img src="../assets/ok.png" class="gdButton center" style="height: 55px; margin-top: 30px" onclick="$('#mobileInfo').hide()"">
		</div>
    </div>

    <div class="popup" id="steal">
        <div id="stealBox" class="brownbox bounce center supercenter" style="height: 350px; width: 700px">
            <h1 class="center gold" style="margin-top: 10px">Copy Icon</h1>
            <p id="copyFrom" class="white" style="font-size: 24px; margin: 10px auto 5px auto"></p>
            <input type="text" name="gdbrowser" id="playerName" autocomplete="off" placeholder="Username" maxlength="32" style="height: 58px; width: 90%; text-align: center; margin-top: 25px; margin-bottom: 10px;">
            <div id="copyForms"></div>
            <div class="cornerCheckbox" id="copyAllCheckbox" style="position: absolute; bottom: 14px; left: 10px"><input type="checkbox" checked id="copyFullSet"><label for="copyFullSet" class="gdcheckbox gdButton"></label><h2>Full set</h2></div>
            <img src="../assets/ok.png" class="postButton gdButton center" style="height: 55px; margin-top: 30px" id="fetchUser">
            <img class="gdButton xButton" src="../assets/close.png" style="width: 70px" onclick="$('#steal').hide()">
		</div>
    </div>
    
    <div class="popup" data-nosnippet id="settings">
        <div class="brownbox bounce center supercenter" style="width: 820px">
            <h1 class="center gold" style="margin-top: 10px; margin-bottom: 20px;">Settings</h1>
            <div class="settingList">
                <div class="help" help="Allows robots to play spider animations and vice versa"><input type="checkbox" class="iconsetting" id="box-cursed"><label for="box-cursed" class="gdcheckbox gdButton"></label><h2>Cursed animations</h2></div>
                <div class="help" help="Remembers the last icon you selected for each form, and automatically re-selects it when switching to that tab"><input type="checkbox" class="iconsetting" id="box-rememberform"><label for="box-rememberform" class="gdcheckbox gdButton"></label><h2>Icon set mode</h2></div>
            </div> 
            <div class="settingList">
                <div class="help" help="Sorts the colors by internal ID instead of their in-game order"><input type="checkbox" class="iconsetting" id="box-sort"><label for="box-sort" class="gdcheckbox gdButton"></label><h2>Unsort Colors</h2></div>
                <div class="help" help="Prevents glow color from auto-changing whenever color 2 is changed"><input type="checkbox" class="iconsetting" id="box-unlinkglow"><label for="box-unlinkglow" class="gdcheckbox gdButton"></label><h2>Unlink glow from col2</h2></div>
            </div>
            <p class="white" id="helpText" style="font-size: 24px; margin-bottom: 0; height: 50px;">(Hover over a setting for information)</p>
            <img src="../assets/ok.png" class="postButton gdButton center" style="height: 55px; margin-top: 30px; margin-bottom: 20px" onclick="$('#settings').hide()">
            <img class="gdButton xButton" src="../assets/close.png" style="width: 70px" onclick="$('#settings').hide()">
        </div>
	</div>

    <img id="iconKitLogo" src="../assets/iconkit.png" style="margin: 7px 0px; height: 50px"><br>
    <h2 style="margin: 5px auto 0px auto; display: none; height: 45px" id="howto"><span style='color: #aaaaaa'>(hover over an icon for info)</span></h2>

    <div class="iconbox">
        <canvas id="result" style="transform: translateY(-35px)">
    </div>

    <hr id="gdfloor">
    <div class="menuButtons">
        <button class="blankButton menuButton" onclick="icon.psdExport()" title="Download layered PSD"><img src="../assets/iconkitbuttons/psd.png"></button>
        <button class="blankButton menuButton" id="copyToClipboard" title="Copy to clipboard"><img src="../assets/iconkitbuttons/copy.png"></button>
        <button class="blankButton menuButton" onclick="icon.pngExport()" title="Download icon"><img src="../assets/iconkitbuttons/save.png"></a></button>
        <button class="blankButton menuButton" id="getUserIcon" title="Get player icon"><img src="../assets/iconkitbuttons/steal.png"></button>
        <button class="blankButton menuButton" id="randomIcon" title="Random Icon"><img src="../assets/iconkitbuttons/shuffle.png"></button>
    </div>

    <div id="iconTabs"></div><br>

    <div id="extraUnlockText_off" style="display: none">
        <p style="margin: 0px 0px 16px 0px; color: white">Check back soon!</p>
    </div>

    <div id="iconLayer">
        <div class="sideButtons" id="leftSide">
            <button title="Colors" class="blankButton gdButton" id="colorToggle"><img src="../assets/iconkitbuttons/colors.png" style="width: 75px"></button>
            <button title="Glow" class="blankButton glowToggle gdButton" id="glowbtn"><img id="glow" src="../assets/iconkitbuttons/streak_off.png"></button>
            <button title="Dev Tools" class="blankButton gdButton" id="devToolsToggle"><img id="devToolsIcon" src="../assets/iconkitbuttons/dev_off.png"></button>
        </div>

        <div id="iconKitParent" class="iconKit iconSetup">
            <div id="iconprogressbar"><div id="iconloading"></div></div>
        </div>

        <div id="colorLayer" class="iconKit iconSetup" style="display: none;">
            <div id="iconprogressbar"><div class="fakeloading"></div></div>

            <div id="colorLabels">
                <button id="cc1" colType="1" altCol="2" class="colorLabel blankButton selectedColorType" title="Primary Color"><img src="../assets/col1.png"></button><input type="color" id="cp1" class="colorPicker">
                <button id="cc2" colType="2" altCol="1" class="colorLabel blankButton" title="Secondary Color"><img src="../assets/col2.png"></button><input type="color" id="cp2" class="colorPicker">
                <button id="ccg" colType="g" altCol="2" class="colorLabel blankButton" title="Glow Color" style="display: none"><img src="../assets/colG.png"></button><input type="color" id="cpg" class="colorPicker">
                <button id="ccw" colType="w" altCol="1" class="colorLabel blankButton" title="White Highlights" style="display: none"><img src="../assets/colW.png" style="background-color: rgb(255, 255, 255)";></button><input type="color" id="cpw" class="colorPicker">
                <button id="ccu" colType="u" altCol="1" class="colorLabel blankButton" title="UFO Dome" style="display: none"><img src="../assets/colU.png" style="background-color: rgb(255, 255, 255)";></button><input type="color" id="cpu" class="colorPicker">
            </div>

            <div id="colorList"></div>

            <p class="hideIfSmall" style="color: white; opacity: 66%; line-height: 7px;">Right click to change <span id="altColor">secondary</span> color</p>
        </div>

        <div id="devTools" class="iconKit droppable" style="display: none">
            <div>
                <h2>Icon</h2>
                <div id="devCustomIcon">
    
                    <p>Upload .png</p>
                    <div class="fileBox gdButton customUploader" target="devUploadPNG" id="devViewPNG"></p></div>
                    <input id="devUploadPNG" style="display: none" type="file" accept="image/png">
    
                    <p>Upload .plist</p>
                    <div class="fileBox gdButton customUploader" target="devUploadPLIST" id="devViewPLIST"></p></div>
                    <input id="devUploadPLIST" style="display: none" type="file" accept=".plist,.dat,.xml">
    
                    <p>Quality</p>
                    <select id="devUploadQuality" class="fancySelect">
                        <option val="uhd">UHD</option>
                        <option val="hd">HD</option>
                        <option val="low">Low</option>
                    </select>
                </div>
    
                <div style="width: 100%; margin-top: 10px">
                    <button class="longButton devLayerBtn gdButton" disabled id="devLoadIcon">
                        <h2 style="width: 100%; margin: 0px 0px; font-size: 30px;">Load icon</h2>
                    </button>
                </div>

                <p class="hideIfSmall" style="color: white; opacity: 66%; line-height: 9px;">Files can also be dragged here</p>
    
            </div>
    
            <div id="devLayersSection">
                <div style="display: flex; flex-direction: column; align-items: center; overflow: visible;">
                    <h2>Layers</h2>
                    <div id="devIconLayers">
                        <button class="longButton devLayerBtn gdButton" id="backOneLayer">‚óÄÔ∏è Back</button>
                    </div>
                </div>
            </div>
    
            <div>
                <h2 id="devSettingsHeader">Settings</h2>
                <p class="noLayerSelected" style="color: white">No layer selected...</p>
                <div id="devIconSettings" class="yesLayerSelected">
                    <div>
                        <input type="checkbox" id="devToggleVisible"><label for="devToggleVisible" class="gdcheckbox gdButton"></label>
                        <p>Visible</p>
                    </div>
                    
                    <div id="devColorConfig">
                        <button id="devColor" class="colorLabel blankButton" onclick="$('#devColorPicker').trigger('click')" style="margin-left: 28px !important; margin-right: 9px !important">
                            <img src="../assets/colB.png" style="width: 40px; transition-duration: 0ms;">
                        </button>
                        <input type="color" id="devColorPicker" class="colorPicker">
                        <p>Color</p>
                    </div>
    
                    <div id="devSpriteOffset" style="margin-top: 30px">
                        <h2 id="spriteOffsetHeader" style="font-size: 32px; margin-bottom: 20px">Sprite Offset</h2>
                        <div style="margin-bottom: 10px"><p>X: </p> <input id="spriteOffsetX" type="number" value="0" onwheel="event.stopImmediatePropagation()"> </div>
                        <div><p>Y: </p> <input id="spriteOffsetY" type="number" value="0" onwheel="event.stopImmediatePropagation()"> </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sideButtons" id="rightSide">
            <button title="Expand icon list" class="blankButton gdButton" id="expand" ><img id="expandIcon" src="../assets/iconkitbuttons/expanded_off.png"></button>
            <button title="Unlock details" class="blankButton gdButton" id="unlockIcon"><img id="lock" src="../assets/iconkitbuttons/unlockinfo_off.png"></button>
        </div>
    </div>

    <div id="secondaryIconOptions" style="display: none">
        <div id="showSecondaryIcon" class="specialIconSetting">
            <input type="checkbox" id="enableSecondaryIcon"><label for="enableSecondaryIcon" class="gdcheckbox gdButton"></label>
            <h2>Show icon</h2>
        </div>
    </div>

    <div id="ballRollOptions" style="display: none;">
        <div class="animationSelector" style="margin-top: 10px">
            <h2 style="margin-right: 20px">Roll speed:</h2>
            <input id="rollSpeed" style="width: 250px" type="range" value="0" placeholder="0" min="-10" max="10" step="0.1">
            <input id="rollSpeedBox" type="number" value="0">

            <button class="blankButton gdButton" id="resetBallRotation" style="margin-left: 15px">
                <img src="../assets/iconkitbuttons/trash.png" style="width: 58px">
            </button>
        </div>
    </div>

    <div id="animationOptions" style="display: none;">
        <div class="animationSelector">
            <h2 style="margin-right: 20px">Animation: </h2>
            <select id="robotAnimation"></select>
        </div>
        <div class="animationSelector">
            <h2 style="margin-right: 20px">Speed:</h2>
            <input id="animationSpeed" style="width: 250px" type="range" value="1" placeholder="1" min="0.1" max="3" step="0.1">
            <input id="animationSpeedBox" type="number" value="1">
        </div>
    </div>

    <p style="color: rgb(20, 20, 20); margin-top: 30px; margin-bottom: 25px; line-height: 16px">
        Created by <a target=_blank href="https://twitter.com/TheRealGDColon">Colon</a>
		‚Ä¢ Archived by <a target=_blank href="https://www.youtube.com/@Muffin5671">Muffin</a>
        ‚Ä¢ All sprites/assets belong to <a target=_blank href="http://robtopgames.com">RobTop Games</a>
        <br><br>
        <a target=_blank href="https://gdbrowser.com/iconkit/icon.js">Source Code</a> (100% local with <a target="_blank" href="https://pixijs.com/">pixi.js</a>!)
    </p>

    <div style="position:absolute; top: 20px; left: 20px; pointer-events: none">
        <button class="blankButton menuButton" id="customColors" title="Settings" onclick="$('#settings').show()" style="pointer-events: all;" tabindex="0">
            <img src="../assets/iconkitbuttons/cog.png" style="width: 75px">
        </button>
	</div>

    <div class="hideIfSmall" id="extraInfo" style="position:absolute; top: 20px; right: 15px"></div>

    <div class="showIfSmall" style="position:absolute; top: 20px; right: 15px">
        <img class="gdButton" id="extraInfoButton" style="pointer-events: all; width: 50%" src="../assets/smallinfo.png"">
    </div>
    
</div>
</body>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script type="text/javascript" src="./libs/pixi.js"></script>
<script type="text/javascript" src="./libs/pixi-ease.js"></script>
<script type="text/javascript" src="./libs/imagesloaded.js"></script>
<script type="text/javascript" src="./icon.js?v=9e"></script>

<script type="text/javascript" src="./devTools.js?v=9e"></script>

<script type="text/javascript">

const iconCanvas = document.getElementById('result');
const app = new PIXI.Application({ view: iconCanvas, width: 300, height: 300, backgroundAlpha: 0 });

let currentForm = 'cube'

let selectedIcon = "1"          // Icon ID
let selectedForm = 'cube'       // Form
let extraItemsformCopy = 'cube'     // Form for copying

let selectedColorType = "1"     // Color tab selection (primary, secondary, etc)
let altColorType = "2"          // Color tab selection when right-clicking
let enableGlow = false          // Glow?

// Icon colors
let selectedCol = {
    1: 0,
    2: 3,
    g: 3,
    w: null,
    u: null
}

// Shop types enum
const shops = ["the Shop", "Scratch's Shop", "the Community Shop", "the Mechanic", "the Diamond Shop"]

// Global for debugging purposes
let iconStuff = {}
let forms = []
let reloadColors; // function

// Unlock-related variables
let unlockMode = false          // If unlock mode is enabled
let generatedUnlocks = false    // If unlocks have been checked yet
let unlockMethods = {}          // All unlocks, for each form
let unobtainableIcons = {}      // Icons that can't be obtained
let missingUnlocks = []         // Icons with no unlock data yet
let missingHardcodedUnlock = [] // Icons with no 'hardcoded' unlock data yet

// Special settings
let enableSecondary = false     // Secondary icon for ships, ufos, etc
let ballSpeed = 0

// Spider/robot animations
let currentAnimation = {}
let animationMultiplier = 1

// For icon set mode
let lastForms = {}

// For secondary icon
let lastCube;

// Actual icon data, to be generated
let icon = null

// Settings
let iconSettings = (localStorage.iconkit || "").split(",")
iconSettings.forEach(x => {
    $(`#box-${x}`).prop('checked', true)
})

// RNG, for suffle button
function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1) ) + min }

// Convert decimal number to hex code
function toHexCode(decimal) { return "#" + decimal.toString(16).padStart(6, "0") }

// Sets background color for color pickers
function colorBG(colType, col) { 
    let hex = toHexCode(col)
    $(`#cc${colType} img`).css('background-color', hex)
    $(`#cp${colType}`).val(hex)
}

// If dev tab is focused
function onDevTab() {
    return $('#devTools').is(":visible")
}

// Changes the color of the icon, and updates UI elements
// config.skipUpdates: Does not update in dev tools and icon info (useful while dragging in the color picker)
function setColor(type, col, config={}) {
    selectedCol[type] = col.toString()
    let parsedCol = parseIconColor(col)
    if (icon) icon.setColor(type, parsedCol)
    colorBG(type, parsedCol)

    if (config.skipUpdates) return
    updateDevTools()
    updateSelectedColors()
}

// Toggles glow for the icon, and updates UI element
function setIconGlow(glowing) {
    enableGlow = !!glowing
    toggleButtonImage($('#glow'), enableGlow)
    if (!iconSettings.includes("unlinkglow")) setColor("g", selectedCol[2])
    icon.setGlow(glowing)

    checkGlow()
    updateDevTools()
    updateSelectedColors()
}

// check if glow col tab should be visible
function checkGlow() {
    $('#ccg').toggle(!!icon.isGlowing())
}

// check if white or ufo col tab should be visible
function checkWhite() {
    let hasWhite = false; let hasUFO = false;
    let ic2 = icon.secondaryIcon ? icon.secondaryIcon.getAllLayers() : []
    icon.getAllLayers().concat(ic2).forEach(l => {
        if (l.colorType == "w") hasWhite = true
        else if (l.colorType == "u") hasUFO = true
    })

    if (hasWhite) {
        $('#ccw').show()
    }
    else {
        $('#ccw').hide(); setColor("w", 12);
        if (selectedColorType == "w") $('#cc1').trigger('click')
    }

    if (selectedForm == "ufo") {
        $('#ccu').show()
    }
    else {
        $('#ccu').hide(); setColor("u", 12);
        if (selectedColorType == "w") $('#cc1').trigger('click')
    }
}

// check if form has a secondary icon
function hasSecondary() {
    return cubeOffsets[icon.form]
}

// check if animation selector should be visible
function checkFormOptions(form=selectedForm) {
    $('#secondaryIconOptions').toggle(!!hasSecondary())

    if (icon.form == "player_ball") $('#ballRollOptions').show()
    else {
        $('#ballRollOptions').hide()
        resetBallSpeed()
    }

    let animationData = iconStuff.robotAnimations.animations[form]
    if (animationData && !$(`#robotAnimation[form="${form}"]`).is(":visible")) {
        appendAnimations(form, animationData)
    }
    else if (!animationData) $('#animationOptions').hide()
}

function animationSort(anim) {
    return Object.keys(anim).sort((a, b) => a.localeCompare(b))
}

function appendAnimations(form, animationData) {
    let animationNames = animationSort(animationData)
    $('#robotAnimation').html(animationNames.map(x => `<option form="${form}" value="${x}">${x.replace(/_/g, " ")}</option>`))
    $('#robotAnimation').val("idle")
    $('#robotAnimation').attr("form", selectedForm)

    if (iconSettings.includes("cursed")) Object.keys(iconStuff.robotAnimations.animations).forEach(altForm => {
        if (altForm != form) {
            let altNames = animationSort(iconStuff.robotAnimations.animations[altForm])
            $('#robotAnimation').append(altNames.map(x => `<option form="${altForm}" value="${x}">*${x.replace(/_/g, " ")} (${altForm})</option>`))
        }
    })

    $('#animationOptions').show()
}

// Displays extra icon info in the corner of the screen
function getExtraInfo(raw) {
    let custom = (icon && icon.customFiles)
    let formName = iconStuff.forms[selectedForm].name

    let extraInfo = {
        "ID": custom ? `Custom ${formName} (${icon.id || "-"})` : `${formName} ${+selectedIcon}`,
        "Col 1": extraColString(selectedCol[1]),
        "Col 2": extraColString(selectedCol[2])
    }

    if (enableGlow) extraInfo["Glow"] = extraColString(selectedCol.g)
    if ($('#ccw').is(":visible") && (parseIconColor(selectedCol.w) != 0xffffff)) extraInfo["White"] = extraColString(selectedCol.w)
    if ($('#ccu').is(":visible") && (parseIconColor(selectedCol.u) != 0xffffff)) extraInfo["UFO Dome"] = extraColString(selectedCol.u)

    if (icon && icon.secondaryIcon) {
        let i2 = icon.secondaryIcon
        extraInfo["Cube"] = (i2.customFiles ? `Custom (${i2.id || "-"})` : (+i2.id).toString())
    }

    if (!custom) {
        let iconVersion = getVersion(selectedForm, +selectedIcon) || {}
        extraInfo["Update"] = iconVersion.version || "Unknown"
        if (iconVersion.obtainable) extraInfo["Obtainable"] = iconVersion.obtainable

        let foundData = iconStuff.allUnlocks[selectedForm][+selectedIcon]
        if (foundData && foundData.artist) {
            extraInfo["üé® Artist"] = foundData.artistID ? `<a style="color: ${raw ? "cyan" : "white"} !important;" target="_blank" href="/u/${foundData.artistID}.">${foundData.artist}</a>` : foundData.artist
        }
    }

    if (raw) return extraInfo

    let extraData = Object.entries(extraInfo).map(x => `<div><p>${x[0]}: ${x[1]}</p></div>`)

    $('#extraInfo').show()
    $('#extraInfo').html(extraData)
}

// Converts a color ID to an info string, e.g. "1 (#00ff00)"
function extraColString(col) {
    let realCol = parseIconColor(col)
    let hexCol = toHexCode(realCol) 
    let foundGDCol = Object.entries(iconStuff.colors).find(x => rgbToDecimal(x[1]) == realCol)
    return foundGDCol ? `${foundGDCol[0]} (${hexCol})` : hexCol
}

// Toggles a button's icon between the on and off state
function toggleButtonImage(img, force) {
    let src = img.attr("src")
    let isOn = (force !== undefined) ? force : !src.endsWith("_on")
    if (!isOn) src = src.replace("_on", "_off")
    else src = src.replace("_off", "_on")
    img.attr("src", src)
}

// Toggles off all form icons except for the target one
function toggleTabImage(form) {
    $('#iconTabs button img').each(function(x, y) {
        toggleButtonImage($(this), false)
        $(this).parent().removeClass('activeForm')
    })

    let img = $(`#iconTabs button[form="${form}"] img`)
    toggleButtonImage(img, true)
    img.parent().addClass('activeForm')
}

// generate the actual icon!
function generateIcon(cb) {
    let foundForm = parseIconForm(selectedForm)
    loadIconLayers(foundForm, selectedIcon, function(l, sprites) {
        let iconArgs = {app, form: foundForm, id: selectedIcon,
            col1: parseIconColor(selectedCol[1]),
            col2: parseIconColor(selectedCol[2]),
            colG: parseIconColor(selectedCol.g),
            glow: enableGlow
        }
        if (selectedCol.w) iconArgs.colW = parseIconColor(selectedCol.w)
        if (selectedCol.u) iconArgs.colU = parseIconColor(selectedCol.u)
        if (selectedForm == "ball" && ballSpeed != 0) iconArgs.ballSpeed = ballSpeed

        if (animationMultiplier != 1) iconArgs.animationSpeed = animationMultiplier

        if (currentAnimation.form && (iconSettings.includes("cursed") || currentAnimation.form == selectedForm)) {
            iconArgs.animation = currentAnimation.name
            iconArgs.animationForm = currentAnimation.form
        }

        handleNewIcon(new Icon(iconArgs))

        lastForms[selectedForm] = selectedIcon

        if (cb) cb()
    })
}

// When the icon cahnges...
function handleNewIcon(newIcon) {

    let oldIcon = icon
    icon = newIcon  // global

    icon.updatePosition()

    getExtraInfo()           // update the info string
    checkGlow()              // check if glow is on
    checkFormOptions()       // check form-specific options
    checkWhite()             // check if it has white
    updateDevTools()         // change dev tools layers
    updateSelectedColors()   // change selected colors

    refreshDevTools()
    if (enableSecondary) addSecondary()

    // cache or dispose old icon
    if (icon.form == "player") {
        if (lastCube) lastCube.destroy()
        lastCube = icon
    }
    else if (oldIcon && oldIcon != lastCube) oldIcon.destroy()
}

// fetch way too much icon kit related data
fetch('../api/iconkit').then(res => res.json()).then(iconKitData => {

    iconStuff = iconKitData
    forms = Object.keys(iconStuff.forms)

    // add a button for each form, and set up their container
    forms.forEach(form => {
        $("#iconTabs").append(`<button form="${form}" title="${iconStuff.forms[form].name}" class="blankButton iconTabButton"><img src="../assets/iconkitbuttons/${form}_off.png" style="width: 50px"></button>`)
        $("#copyForms").append(`<button form="${form}" title="${iconStuff.forms[form].name}" class="blankButton copyForm"><img src="../assets/iconkitbuttons/${form}_off.png" style="width: 50px"></button>`)
        $("#iconKitParent").append(`<div id="${form}s" class="iconContainer"></div>`)
    })

    // extra items tab, if unlock mode is on
    $("#iconTabs").append(`<button form="extraItems" title="Extra" class="blankButton" id="extraItemsToggle" style="display: none"><img src="../assets/iconkitbuttons/extra_off.png" style="width: 50px"></button>`)
    $('#iconKitParent').append(`<div id="extraItems" class="iconContainer" style="flex-direction: column; display: none"></div>`)
    $('#extraItemsToggle').click(onExtraItems)

    // add icon to the full icon list
    function appendIcon(formName) {
        
        let formInfo = iconStuff.forms[formName]
        let formStr = (formInfo ? formInfo.form : formName) // get internal name
        let formCount = iconStuff.iconCounts[formStr] // get amount of that form

        let imagesLoaded = 0
        let totalLoaded = 0  
        let formContainer = $('#' + formName + 's')

        let hasMini = ["cube", "ball", "ship"].includes(formName)

        // add each icon to the container
        for (let i = 1; i <= formCount; i++) {
            let ic = $(`<button num="${i}" form="${formName}" class="blankButton iconButton" id="${formName}-${i}"><img src="./premade/${formName}_${i}.png" title="${formInfo.name} ${i}"></button>`)
            formContainer.append(ic)
            if (generatedUnlocks) checkElementUnlock(ic)
        }

        if (hasMini) formContainer.append(`<button num="0" form="${formName}" class="blankButton iconButton" id="${formName}-0"><img src="./premade/${formName}_0.png" title="Mini ${formInfo.name}"></button>`)

        // loading bar
        formContainer.imagesLoaded(function() {}).progress(function() {
            imagesLoaded += 1;
            totalLoaded = imagesLoaded / formContainer.find('img').length * 100
            $('#iconloading').css('width', `${totalLoaded}%`)
        }
    )}

    // prepare color list
    reloadColors = function() { 
        let group = []
        $('#colorList').empty()

        function addGroup() {
            let g = $('<div class="colorGroup"></div>')
            $('#colorList').append(g)
            group.forEach(x => g.append(x))
            group = []
        }

        let unsort = iconSettings.includes("sort")
        iconStuff.colorOrder.new.forEach(function (p, n) {
            if (unsort) p = n;
            let colRGB = iconStuff.colors[p]
            let hexCode = toHexCode(rgbToDecimal(colRGB)).slice(1)
            let isSelected = false
            let newCol = $(`<button col=${p} class="gdButton blankButton iconColor" hex="${hexCode}" title="Color ${p} (#${hexCode})" id="col-${p}"><div style="background-color: rgb(${colRGB.r}, ${colRGB.g}, ${colRGB.b})"></button>`)
            group.push(newCol)
            if (group.length % 4 == 0 && (unsort || n != 103)) addGroup()
            if (generatedUnlocks) checkElementUnlock(newCol)
        })
        addGroup()
        checkMissingUnlocks()
        updateSelectedColors()
    }

    reloadColors()
    
    // sample icon
    let sample = JSON.parse(iconStuff.sample);
    enableGlow = sample[3] > 0;
    selectedIcon = sample[0]

    setColor(1, sample[1])
    setColor(2, sample[2])
    setColor("g", isNaN(sample[4]) ? selectedCol[2] : sample[4])

    // set sample icon to selected
    $('body').imagesLoaded(function () {
        $(`[num="${sample[0]}"][form="cube"]`).addClass('iconSelected');
    })

    // generate sample, disable glow after first generated
    generateIcon(() => {
        icon.glow = false;
        enableGlow = false
    }) 

    // changing tabs
    $(document).on('click', '.iconTabButton', function () {
        const form = $(this).attr('form')
        const formElement = $('#' + form + 's')
        
        let oldForm = currentForm;
        currentForm = form  // set form
        closeDevTab()
        toggleTabImage(form)

        $('#colorLayer').hide()
        $('#iconKitParent').show()

        $('#iconKitParent .iconContainer').hide()

        if (formElement.html() == "") appendIcon(form)

        if (iconSettings.includes("rememberform") && form != oldForm) {
            $(`.iconButton[form="${form}"][num="${lastForms[form] || 1}"]`).trigger("click")
        }

        checkMissingUnlocks()
        
        formElement.show()
    })

    // select first tab
    $('#iconTabs').find('.iconTabButton').first().click()
})

// icon copying - clicking buttonk
$("#getUserIcon").click(function() {
    $(`.copyForm[form=${currentForm}]`).trigger('click')
    if (iconSettings.includes("rememberform")) $('#copyAllCheckbox').show()
    else $('#copyAllCheckbox').hide()
    $('#steal').show();
    $('#playerName').focus()  
    $('#playerName').select()  
})

// icon copying - selecting a form
$(document).on('click', '.copyForm', function () {
    $('.copyForm').each(function(x, y) {$(this).children().first().attr('src', $(this).children().first().attr('src').replace('_on', '_off'))})
    formCopy = $(this).attr('form')
    let src = $(this).children().first().attr('src')
    $(this).children().first().attr('src', src.replace('_off', '_on'))
})

// on clicking a new icon
$(document).on('click', '.iconButton', function () {
    if ($(this).parents('#extraItems').length) return

    $(".iconButton").removeClass("iconSelected");
    $(this).addClass('iconSelected');
    let oldForm = selectedForm
    selectedIcon = $(this).attr('num');
    selectedForm = $(this).attr('form');

    if (selectedForm != oldForm) currentAnimation = {}

    generateIcon()
})

// on clicking a color
$(document).on('click contextmenu', '.iconColor', function (e) {
    let col = $(this).attr('col')
    if (!col) return
    let colType = selectedColorType
    if (e.type == "contextmenu") {
        colType = altColorType
    }
    let alsoChangeGlow = (colType == 2 && selectedColorType != "g" && enableGlow && selectedCol.g == selectedCol[2] && !iconSettings.includes("unlinkglow"))
    
    setColor(colType, col, {skipUpdates: true})
    if (alsoChangeGlow) setColor("g", col, {skipUpdates: true})
    checkGlow()

    updateSelectedColors()
    return false
})

// clicking a color category
$(document).on('click', '#colorLabels .colorLabel', function() {
    let selected = $(this).hasClass('selectedColorType')
    let colType = $(this).attr('colType')
    let altType = $(this).attr('altcol')

    updateAltColorType(altType)

    // change selection
    if (!selected) {
        $('.selectedColorType').removeClass('selectedColorType')
        $(this).addClass('selectedColorType')
        selectedColorType = colType
        updateSelectedColors()
    }

    // same selection
    else {
        let picker = $("#cp" + colType)
        picker.val(toHexCode(parseIconColor(selectedCol[colType])))
        picker.trigger('click')
    }
})

// change which color gets modified on right click
function updateAltColorType(type) {
    if (type == "2") {
        altColorType = 2
        $('#altColor').text("secondary")
    }

    else {
        altColorType = 1
        $('#altColor').text("primary")
    }
}

// makes color pickers actually change the color
function trackColorChanges(picker, colType) {
    picker.on('input change', function(e) {
        setColor(colType, picker.val().slice(1))
    })
}

trackColorChanges($('#cp1'), "1")
trackColorChanges($('#cp2'), "2")
trackColorChanges($('#cpg'), "g")
trackColorChanges($('#cpw'), "w")
trackColorChanges($('#cpu'), "u")

// copy icon to clipboard
$('#copyToClipboard').click(function() {
    if ($(this).hasClass('greyedOut')) return
    icon.copyToClipboard()
    let copyIcon = $(this).find('img')
    $(this).addClass('greyedOut')
    copyIcon.attr('src', '../assets/iconkitbuttons/copied.png')
    setTimeout(() => {
        $(this).removeClass('greyedOut')
        copyIcon.attr('src', '../assets/iconkitbuttons/copy.png')
    }, 420);
})

// edit robot animation
$('#robotAnimation').on('change', function() {
    let prevForm = currentAnimation.form
    currentAnimation = { name: $(this).val(), form: $('#robotAnimation').find(":selected").attr('form') }
    if (!icon.customFiles && currentAnimation.form != prevForm) {
        generateIcon(() => icon.setAnimation(currentAnimation.name, currentAnimation.form))
    }
    else icon.setAnimation(currentAnimation.name, currentAnimation.form)
})

// hover text for settings menu
let hoverText = $('#helpText').html()
$(".help").hover(function() { 
    $(this).css('color', 'rgba(200, 255, 255)')
    $('#helpText').html($(this).attr('help')) 
}, function() {
    $(this).css('color', 'white')
    $('#helpText').html(hoverText) 
})

// changing settings
$(document).on('change', '.iconsetting', function (e) {
    let checkedSettings = []
    $('.iconsetting:checkbox:checked').each((i, x) => { checkedSettings.push(x.id.split('-')[1]) })
    iconSettings = checkedSettings
    switch ($(this).attr('id').slice(4)) {
        case "sort": reloadColors(); break;
        case "ufo": generateIcon(); break;
        case "cursed":
            $('#animationOptions').hide();
            checkFormOptions();
            $('#robotAnimation').trigger('change');
            break;
    }
    localStorage.iconkit = checkedSettings.join(",")
})

// extra unlockable items - indivdual
function getExtraItem(type, name, id) {
    return $(`<button num="${id}" form="${type}" class="blankButton iconButton" id="${type}-${id}"><img src="./items/${type}_${id}.png" title="${name} ${id}"></button>`)
}

// extra unlockable items - adding a row
function addExtraSection(type, name, order) {
    let itemCount = iconStuff.items.counts[type]
    if (!itemCount) return

    if ($('.extraItemSection').length > 0) $('#extraItems').append('<hr class="extraItemHR">')
    let newSection = $(`<div class="extraItemSection"></div>`)

    if (!order) {
        for (let i = 1; i <= itemCount; i++) {
            newSection.append(getExtraItem(type, name, i))
        }
    }

    else {
        order.forEach(x => {
            newSection.append(getExtraItem(type, name, x))
        })
    }

    $('#extraItems').append(newSection)
}

// achievements
const achTypes = { dart: "wave", bird: "ufo", icon: "cube", player: "cube", player_ball: "ball", special: "trail", death: "deathEffect", explosion: "deathEffect" }
function addUnlock(type, id, str, unobtainable) {
    if (!str) return
    let iconID = +id
    let t = achTypes[type] || type
    let dict = (unobtainable ? unobtainableIcons : unlockMethods)
    if (!dict[t]) dict[t] = {}
    if (dict[t][iconID]) return
    else dict[t][iconID] = str
    return true
}

function checkElementUnlock(el) {
    let method = getUnlockFromElement(el)
    if (!method || method == "Unobtainable") {
        missingUnlocks.push(el)
    }
}

function checkMissingUnlocks() {
    if (unlockMode) missingUnlocks.forEach(x => x.addClass("hasNoUnlock"))
}

$('#unlockIcon').click(function() {
    generateUnlocks()

    unlockMode = !unlockMode
    if (unlockMode) {
        toggleButtonImage($('#lock'), true)
        $('#howto').show()
        $('#extraUnlockText_on').show()
        $('#extraItemsToggle').show()
        checkMissingUnlocks()
    }
    else {
        toggleButtonImage($('#lock'), false)
        $('#howto').hide()
        $('#extraUnlockText_on').hide()
        $('.hasNoUnlock').removeClass("hasNoUnlock")
        $('#extraItemsToggle').hide()
        if ($('#extraItems').is(":visible")) $(`.iconTabButton[form=${selectedForm}]`).click()
    }
})

function generateUnlocks() {
    if (generatedUnlocks) return
    else generatedUnlocks = true

    iconStuff.hardcodedUnlocks.forEach(m => {
        let method;
        switch (m.type) {
            case "vault": method = `Solve a riddle in the ${m.vault}${m.code ? ` (${m.code[0] + ("_").repeat(m.code.length - 1)})` : ""}`; break;
            case "wraith": method = `Redeem in the Secret Room (${m.code || "Unknown code"})`; break;
            case "treasureRoomMilestone": method = `Open ${m.chests} chests in the Treasure Room`; break;
            case "path": method = `Complete the Path of ${m.path}`; break;
            case "gauntlet": method = `Complete the ${m.gauntlet} gauntlet`; break;
            case "destroyPlayers": method = `Destroy ${m.count} player${m.count == 1 ? "" : "s"} on the menu`; break;
            case "adChest": method = `Open ad chest #${m.ad} in GD Lite`; break;
            case "goldChest": method = `Open gold chest #${m.chest}`; break;
            case "unknownChest": method = `Found in an unknown chest${m.guess ? ` (possibly ${m.guess}?)` : ""}`; break;
            default: method = m.unlock
        }
        addUnlock(m.form, m.id, method)
    })

    iconStuff.treasureRoom.forEach(t => {
        if (!t.hasIcon) return
        t.rewards.filter(x => x.item == "item").forEach(r => {
            addUnlock(r.type, r.iconID, `Found in a ${t.keys}-key chest in the Treasure Room`)
        })
    })

    iconStuff.shops.forEach(m => {
        addUnlock(m.type, m.icon, `Purchase from ${shops[m.shop] || "somewhere"} for <ca>${m.price}</ca> ${m.shop == 4 ? "diamonds" : "orbs"}`)
    })

    iconStuff.achievements.forEach(a => {
        let desc = a.description
        .replace("Demon difficulty level", "demon")
        .replace("Insane difficulty rated level", "insane level")
        
        addUnlock(a.rewardType, a.rewardID, desc)
    })

    addExtraSection("deathEffect", "Death Effect")
    addExtraSection("trail", "Trail")
    addExtraSection("shipFire", "Ship Fire")
    addExtraSection("item", "Special Item", [18, 19, 20])
    addExtraSection("item", "Special Item", [1, 2, 3, 5, 4, 16, 17])

    Object.entries(iconStuff.allUnlocks).forEach(x => {
        let [form, icons] = x
        Object.values(icons).forEach(i => {

            if (unlockMethods[form][i.id]) return;

            if (i.unobtainable) {
                addUnlock(form, i.id, true, true)
            }
            else if (i.unlock) {
                let added = addUnlock(form, i.id, i.unlock)
                if (added && !isUnlockedByDefault(i.id, form)) missingHardcodedUnlock.push({ form, id: i.id, message: unlockMethods[form][i.id] })
            }
        })
    })

    $('.iconButton, .iconColor').each(function() {
        checkElementUnlock($(this))
    }) 
}

// expand icon list
$('#expand').click(function() {
    let exp = $('#expandIcon')
    let ikp = $('#iconKitParent')
    let expanded = ikp.hasClass("expanded")
    if (!expanded) {
        toggleButtonImage(exp, true)
        ikp.addClass("expanded")
    }
    else {
        toggleButtonImage(exp, false)
        ikp.removeClass("expanded")
    }
})

$(document).on('mouseover', '.iconButton, .iconColor', function () {
    if (unlockMode && generatedUnlocks) {
        $(this).addClass('iconHover')
        let unlockInfo = getUnlockFromElement($(this))
        if (!unlockInfo || unlockInfo == "Unobtainable") $('#howto').html(`<span style='color: #aaaaaa'>${unlockInfo || "(no info available)"}</span>`)
        else $('#howto').html(unlockInfo)
    }
})

$(document).on('mouseleave', '.iconButton, .iconColor', function () {
    $(this).removeClass('iconHover')
    $('#howto').html("<span style='color: #aaaaaa'>(hover over an icon for info)</span>")
})

// shuffle button
$("#randomIcon").click(function() {

    let iconPool = iconStuff.iconCounts
    if (!iconPool) return;

    const formCount = iconStuff.iconCounts[iconStuff.forms[selectedForm].form]
    const colorCount = Object.keys(iconStuff.colors).length

    selectedIcon = randInt(1, formCount)

    setColor(1, randInt(0, colorCount - 1), {skipUpdates: true})
    setColor(2, randInt(0, colorCount - 1), {skipUpdates: true})
    setColor("g", selectedCol[2], {skipUpdates: true})
    
    selectedCol.w = null
    selectedCol.u = null

    enableGlow = (randInt(0, 2) == 1)   // 1 in 3 chance of glow
    generateIcon()

    $(`#${selectedForm}-${selectedIcon}`).trigger('click')

    toggleButtonImage($('#glow'), enableGlow)
})

$('#glowbtn').click(function () {
    setIconGlow(!enableGlow)
})

// color tab
$("#colorToggle").click(function() {
    closeDevTab()
    $('#iconKitParent').hide()
    $('#colorLayer').show()
})

// extra items tab
function onExtraItems() {
    closeDevTab()
    $('#iconKitParent .iconContainer').hide()
    $('#extraItems').show()
    toggleTabImage("extraItems")
}

// dev tools tab
$("#devToolsToggle").click(function() {
    if (!icon) return
    else if (onDevTab()) return $('.activeForm').click()
    if (!devStuff.ready) refreshDevTools()
    $('.iconSetup').hide()
    $('#devTools').show()
    toggleButtonImage($('#devToolsIcon'), true)
})

function closeDevTab() {
    $('#iconKitParent').show()
    $('#devTools').hide()
    toggleButtonImage($('#devToolsIcon'), false)
}

// secondary icon toggle
$('#enableSecondaryIcon').click(function() {
    enableSecondary = $(this).prop('checked')

    if (enableSecondary) {
        addSecondary()
    }

    else {
        icon.removeSecondaryIcon()
        refreshDevTools()
        getExtraInfo()
    }
})

// add secondary icon
function addSecondary() {
    if (hasSecondary()) icon.addSecondaryIcon(lastCube || lastForms.cube || 1, false, () => {
        refreshDevTools()
        checkWhite()
    })
}

// info button, for mobile
$('#extraInfoButton').click(function() {
    let extraStuff = getExtraInfo(true) || {}
    if (!extraStuff.ID) return
    $('#extraInfoText').text(extraStuff.ID)
    let extraLines = []
    generateUnlocks()
    Object.entries(extraStuff).forEach(x => {
        if (x[0] == "ID") return;
        let spl = x[1].split(" (")
        if (spl[1]) spl[1] = `<span class="faded"> (${spl[1]}</span>`
        extraLines.push(`<p>${x[0]}: <span class="lime">${spl[0]}</span>${spl[1] || ""}</p>`)
    })
    let toUnlock = getUnlockMethod(selectedIcon, selectedForm)
    if (toUnlock) extraLines.push(`<p class="extraUnlockMethod">${toUnlock}</p>`)
    $("#extraInfoPopup").html(extraLines.join(""))
    $('#mobileInfo').show()
})

// on confirm for copying icon from user
$("#fetchUser").click(async function () {
    let user = $("#playerName").val()
    if (!user || !user.length) return $("#steal").hide()

    $(`.iconTabButton[form=${formCopy}]`).trigger('click')
    
    $("#steal").hide()

    let info = await fetch('../api/profile/' + user).then(res => res.json()).catch(e => {})
    if (info == "-1") info = {}
    info.cube = info.icon

    let iconIndex = info[formCopy] || 1

    let iconBtn = $(`#${formCopy}-${Math.min(iconIndex, $(`.iconButton[form=${formCopy}]`).length)}`)
    iconBtn.trigger('click')
    iconBtn[0].scrollIntoView({ block: 'center' })

    let col2 = isNaN(info.col2) ? 3 : info.col2

    setIconGlow(info.glow)

    setColor(1, info.col1 || 0, {skipUpdates: true})
    setColor(2, col2, {skipUpdates: true})
    setColor("g", isNaN(info.colG) ? col2 : info.colG, {skipUpdates: true})
    setColor("w", 12, {skipUpdates: true})
    setColor("u", 12)

    let setMode = iconSettings.includes("rememberform")
    if (setMode ? $('#copyFullSet').prop("checked") : true) {
        forms.forEach(f => {
            if (info[f]) lastForms[f] = info[f]
        })
        if (lastCube) {
            lastCube.destroy()
            lastCube = null
        }
    }
})

// Updates which colors should be 'outlined'
function updateSelectedColors() {
    $('.selectedColor').removeClass('selectedColor')
    $('.selectedColorPartial').removeClass('selectedColorPartial')

    let cols = Object.values(selectedCol).filter(x => x !== null)
    let realCols = [selectedCol[1], selectedCol[2], selectedCol.g]

    $('.iconColor').each(function() {
        let id = $(this).attr('col')
        let hex = $(this).attr('hex')
        if (selectedCol[selectedColorType] == hex) {
            selectedCol[selectedColorType] = id
            $(this).addClass('selectedColor')
        }
        else if (selectedCol[selectedColorType] == id) $(this).addClass('selectedColor')
        else {
            let cList = (id == "12") ? realCols : cols  // ignore ufo and w coloring if col is white
            if (cList.includes(id) || cList.includes(hex)) {
                $(this).addClass('selectedColorPartial')
            }
        }
    })

    getExtraInfo()
}

// Get achievement unlock from an icon html element
function getUnlockFromElement(el) {
    let iconNumber = el.attr('num') || el.attr('col')
    let form = el.attr('form')
    if (el.hasClass('iconColor')) {
        let colType;
        if (selectedColorType == 1) colType = 1
        else if (selectedColorType == "g" || selectedColorType == 2) colType = 2
        else return
        form = "color" + colType
    }
    return getUnlockMethod(iconNumber, form)
}

// Check if icon is unlocked by default
function isUnlockedByDefault(id, form) {
    return (form.startsWith("color") && id <= 3) || (form != "item" && id > 0 && (id == 1 || (form == "cube" && id <= 4)))
}

// Get unlock info from a form and ID
function getUnlockMethod(iconNumber, form) {
    if (isUnlockedByDefault(iconNumber, form)) return "Unlocked by default"
    let nope = unobtainableIcons[form] ? unobtainableIcons[form][iconNumber] : null
    if (nope) return "Unobtainable"
    else if (unlockMethods[form]) return unlockMethods[form][iconNumber]
}

// VERY hacky, renders all preview icons
function renderEveryIcon(missingOnly, useColors) {

    if (!window.JSZip) {
        return appendScript("jszip").then(x => renderEveryIcon(missingOnly, useColors))
    }

    let queue = []
    let rendered = []
    let missingIcons = []

    if (missingOnly) {
        Array.from(document.querySelectorAll('.iconButton img')).filter(x => x.naturalWidth == 0).forEach(x => {
            missingIcons.push(x.src.split("/").at(-1))
        })
    }

    Object.keys(iconStuff.iconCounts).forEach(x => {
        let count = iconStuff.iconCounts[x] + 1
        let formName = Object.entries(iconStuff.forms).find(z => z[1].form == x)[0]
        let hasZero = ["player", "player_ball", "ship"].includes(x)
        if (hasZero) count--
        for (let i = hasZero ? 0 : 1; i < count; i++) {
            if (!missingOnly || missingIcons.includes(`${formName}_${i}.png`)) queue.push([x, i])
        }
    })

    if (queue.length == 0) return console.info("No icons to render!")
    else if (!confirm(`This will render and download EVERY ${missingOnly ? "*missing* premade " : ""}icon${useColors ? ", WITH COLORS" : ""}. (${queue.length} total)\n\nUse to generate preview images, otherwise scram.`)) return

    let colArgs = !useColors ? null : {
        col1: parseIconColor(selectedCol[1]),
        col2: parseIconColor(selectedCol[2]),
        colG: parseIconColor(selectedCol.g),
        colW: selectedCol.w ? parseIconColor(selectedCol.w) : undefined,
        colU: selectedCol.u ? parseIconColor(selectedCol.u) : undefined,
        glow: enableGlow
    }

    let queueIndex = 0
    function makeIcon() {
        if (!queueIndex || (queueIndex % 20 == 19)) console.info(`Rendering ${queueIndex+1} / ${queue.length}`)
        let q = queue[queueIndex]
        loadIconLayers(q[0], q[1], async function() {
            let iconArgs = {id: q[1], form: q[0], app}
            if (useColors) iconArgs = Object.assign(iconArgs, colArgs)
            console.log(iconArgs)
            icon = new Icon(iconArgs)
            rendered.push({name: icon.getDownloadString() + ".png", data: await icon.getDataURL()})
            setTimeout(() => {
                queueIndex++
                if (queueIndex < queue.length) makeIcon()
                else {
                    setTimeout(() => {
                        let zip = new JSZip();
                        rendered.forEach(x => zip.file(x.name, x.data.split(",", 2)[1], {base64: true}))
                        zip.generateAsync({type: "blob"}).then(z => {
                            generateIcon()
                            downloadFile(z, "allIcons.zip")
                        })
                    }, 250);
                }
            }, 33);
        })
    }
    makeIcon()
}

function listArtists() {
    let artistList = {}
    Object.values(iconStuff.allUnlocks).map(x => Object.values(x)).flat().forEach(x => {
        if (!x.artist) return
        if (!artistList[x.artist]) artistList[x.artist] = 0
        artistList[x.artist] += 1
    })
    return Object.entries(artistList).map(x => ({ name: x[0], count: x[1] })).sort((a, b) => b.count - a.count)
}

function getVersion(form, id) {
    let oVersion = iconStuff.obtainableVersions[`${form}-${id}`]

    if (form.startsWith("color")) form = "color"
    let group = iconStuff.iconVersions[form]
    if (!group || id < 0) return

    let ver = group.find(x => +id <= x.id) || { v: "?" }
    let obj = { version: ver.v }
    if (oVersion && oVersion.version != ver.v) obj.obtainable = oVersion.version
    if (ver) return obj
}

// animation speed
$('#animationSpeed').on('input', function() {
    animationMultiplier = Number($(this).val())
    $('#animationSpeedBox').val(animationMultiplier)
    if (icon.complex) icon.animationSpeed = animationMultiplier
})

$('#animationSpeedBox').change(function() {
    animationMultiplier = Number(Math.abs(Number($(this).val()) || 1).toFixed(2))
    if (animationMultiplier > 99) animationMultiplier = 99
    else if (animationMultiplier <= 0) animationMultiplier = 0.1
    $('#animationSpeed').val(animationMultiplier)
    $('#animationSpeedBox').val(animationMultiplier)
    if (icon.complex) icon.animationSpeed = animationMultiplier
})

// ball roll speed
$('#rollSpeed').on('input', function() {
    ballSpeed = Number($(this).val())
    $('#rollSpeedBox').val(ballSpeed)
    if (icon.form == "player_ball") icon.setBallSpeed(ballSpeed)
})

$('#rollSpeedBox').change(function() {
    ballSpeed = Number(Math.abs(Number($(this).val()) || 1).toFixed(2))
    if (ballSpeed > 99) ballSpeed = 99
    else if (ballSpeed < -99) ballSpeed = -99
    $('#rollSpeed').val(ballSpeed)
    $('#rollSpeedBox').val(ballSpeed)
    if (icon.form == "player_ball") icon.setBallSpeed(ballSpeed)
})

function resetBallSpeed() {
    ballSpeed = 0
    $('#rollSpeed').val(0)
    $('#rollSpeedBox').val(0)
}

$('#resetBallRotation').click(function() {
    resetBallSpeed()
    icon.setBallSpeed(0, true)
})

function backButton() {
	if (window.history.length > 1 && document.referrer.startsWith(window.location.origin)) window.history.back()
	window.location.href = "../../../../../"
}

$(document).keydown(function(k) {
    if (k.keyCode == 13) { // enter
        if ($("#steal").is(":visible")) $("#fetchUser").trigger('click')
        else if ($(".popup").is(":visible")) return
    }
    if (k.keyCode == 27) { //esc
        if ($(".popup").is(":visible")) return $('.popup').hide()
		// k.preventDefault()
		// $('#backButton').trigger('click')
	}
});

$(document).on('click', '.brownbox, .fancybox', function (e) {
    e.stopPropagation();
})

$(document).on('click', '.popup', function () {
    $('.popup').hide()
})

async function appendScript(name) {
    return new Promise((res, rej) => {
        let script = document.createElement("script")
        script.src = `./libs/${name}.js`
        script.type = "text/javascript"

        script.onload = () => {
            console.info(`-> Imported script: ${name}.js`)
            res();
        }
        script.onerror = () => { rej() }
        
        document.head.appendChild(script)
    })
}
    
</script>


